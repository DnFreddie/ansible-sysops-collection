- name: Verify YAML
  hosts: all
  become: true

  vars: 
    prom_dirs:
      prom_dir: "/opt/prometheus"
      prom_config: "/etc/prometheus.yml"
      prom_data: "/opt/prometheus/data"
      prom_binary: "/opt/prometheus/prometheus"
    prom_port: 9090

  tasks:
    - name: Ensure that the Prometheus service is started
      ansible.builtin.service:
        name: prometheus
        state: started
        enabled: true
      check_mode: yes
      become: yes
      register: service_state
      failed_when: service_state.failed

    - name: Ensure that the files and directories exist
      ansible.builtin.stat:
        path: "{{ item }}"
      register: item_stat
      loop: "{{ prom_dirs.values() }}"

    - name: Fail if any required file or directory is missing
      ansible.builtin.fail:
        msg: "The file or directory {{ item }} is missing!"
      when: item_stat.results | selectattr('stat.exists', 'equalto', false) | list | length > 0
      loop: "{{ prom_dirs.values() }}"

    - name: Check if port {{ prom_port }} is open
      ansible.builtin.wait_for:
        port: "{{ prom_port }}"
        timeout: 5

